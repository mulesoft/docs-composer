= コンポーザフローの構築

xref:ms_composer_checklist.adoc[準備チェックリスト]​に記載された情報を収集したら、フローを構築、​xref:ms_composer_activation.adoc[アクティブ化]​、​xref:ms_composer_monitoring.adoc[監視]​できます。フローの構築には、新しいフローを作成したり、既存のフローを複製したり、トリガを追加してテストしたり、フローによって実行される各アクションを実行順序で追加してテストしたり、アクティブ化する前に最終的に新しいフローをテストして完了したりする作業が含まれます。

各トリガおよびアクションをフローに追加するときに​xref:ms_composer_test_flow.adoc[テスト]​します。

[[flow-details-page]]
== フローの詳細ページ 

*[Flow Details (フローの詳細)]*​ ページにアクセスして、フローの詳細を確認します。

ifeval::["{product}"=="salesforce"]
image::images/flow-details-sf.png[*フローの詳細*ページ]
endif::[]

ifeval::["{product}"=="mulesoft"]
image::images/flow-details-ms.png[*フローの詳細*ページ]
endif::[]

[calloutlist]
. フローの名前。 
. フローの詳細:
.. *Created On (作成日)*​: ブラウザで設定されているタイムゾーンでの、フローが作成された日付。
.. *Flow ID (フロー ID)*​: フローの ID。 
.. *Flow Owner (フローオーナー)*​: フローのオーナー。 
.. *Last Modified (最終更新日)*​: ブラウザで設定されているタイムゾーンでの、フローが最後に更新された日付。
.. *Status (状況)*​: フローの状況。状況は [active (アクティブ)] または [inactive (非アクティブ)] です。
. フローの ​*Run History (実行履歴)*​:
.. *Start Date (開始日)*​: ブラウザで設定されているタイムゾーンでの、フローが開始された日付。
.. *End Date (終了日)*​: ブラウザで設定されているタイムゾーンでの、フローが終了した日付。
.. *Status (状況)*​: フローの状況。状況は ​`[SUCCESS (成功)]`​ または ​`[FAILED (失敗)]`​ です。 
.. *Error (エラー)*​: フローが失敗した場合は、失敗の内容を示すエラーメッセージが返されます。 
. フローのアクション。アクティブなフローは削除、複製、または表示できます。非アクティブなフローは編集できませんので注意してください。
. *[Run History (実行履歴)]*​ アクション。​*[Run History (実行履歴)]*​ セクションを更新したり、指定した条件でセクションを絞り込んだりできます。 

== フローを作成する

新しいフローを (最初からまたはテンプレートから) 作成したり、既存のフローを複製したりできます。

[[create-a-new-flow]]
=== 新しいフローを最初から作成する

新しいフローを最初から作成する手順は、次のとおりです。

ifeval::["{product}"=="salesforce"]
. コンポーザの ​*[Home (ホーム)]*​ ページで、​*[Create New Flow (新規フローを作成)] > [Create Flow from Scratch (フローを最初から作成)]*​ をクリックします。 +
自動的にフローに名前が付けられます。
. 必要に応じて、​*[​_フロー名_​]*​ の横にある鉛筆アイコンをクリックしてフローの名前を変更します。有効な文字: A-Z、a-z、0-9、スペース、ハイフン ( - )、ドット ( . )、アンダースコア ( _ )。
. *[Save (保存)]*​ をクリックします。
endif::[]

ifeval::["{product}"=="mulesoft"]
. コンポーザの ​*[Home (ホーム)]*​ ページで、​*[Create new flow (新規フローを作成)] > [Create Flow from Scratch (フローを最初から作成)]*​ をクリックします。 +
自動的にフローに名前が付けられます。
. 自動的に作成された新しいフローの名前を変更するには、​*[Untitled Flow (タイトル未定のフロー)]*​ の横にある鉛筆アイコンをクリックし、A-Z、a-z、0-9、スペース、ハイフン ( - )、ドット ( . )、アンダースコア ( _ ) の任意の文字を使用してカスタム名を作成します。
. *[Save (保存)]*​ をクリックします。
endif::[]

これでフロートリガを作成する準備ができました。

[[create-a-new-flow-from-template]]
=== テンプレートから新しいフローを作成する

テンプレートから新しいフローを作成する手順は、次のとおりです。

. コンポーザの ​*[Home (ホーム)]*​ ページで、​*[Create new flow (新規フローを作成)] > [Create Flow from Template (テンプレートからフローを作成)]*​ をクリックします。
. テンプレートオプションを調べて、使用するテンプレートを選択します。
. 前提条件を満たしていることを確認し、満たしている場合は、​*[Use this Template (このテンプレートを使用)]*​ をクリックします。
. フローに必要な接続と情報を設定します。
. *[Create flow (フローを作成)]*​ をクリックします。

これでフローを使用する準備ができました。テンプレートについての詳細は、​xref:ms_composer_build_a_flow_using_templates.adoc[「テンプレートを使用したフローのビルド」]​を参照してください。

=== 既存のフローを複製する

既存のフローを複製する手順は、次のとおりです。

ifeval::["{product}"=="salesforce"]
. *[Composer Flows (コンポーザフロー)]*​ から、複製するフローの名前をクリックします。コンポーザに ​*[Flow Details (フローの詳細)]*​ ページが表示されます。
. *[Clone (複製)]*​ をクリックします。
. コンポーザは、既存のフローをコピーして、[Flow Details (フローの詳細)] ページで開きます。フローの名前は ​*[Copy of ​_original flow name_​ (​_元のフロー名_​のコピー)]*​ となります。
. 必要に応じて、​*[Copy of ​_original flow name_​ (​_元のフロー名_​のコピー)]*​ の横にある鉛筆アイコンをクリックしてフローの名前を変更します。有効な文字: A-Z、a-z、0-9、スペース、ハイフン ( - )、ドット ( . )、アンダースコア ( _ )。
. *[Save (保存)]*​ をクリックします。
endif::[]

ifeval::["{product}"=="mulesoft"]
. サイドバーから、​*[Flows (フロー)]*​ をクリックします。
. *[Flows (フロー)]*​ ページで、複製するフローの名前をクリックします。
. *[Clone (複製)]*​ をクリックします。
+
コンポーザは、既存のフローをコピーして、[Flow Details (フローの詳細)] ページで開きます。フローの名前は ​*[Copy of ​_original flow name_​ (​_元のフロー名_​のコピー)]*​ となります。
. フローの名前を変更するには、​*[Copy of _original flow name_ (​_元のフロー名_​のコピー)]*​ の横にある鉛筆アイコンをクリックし、A-Z、a-z、0-9、スペース、ハイフン ( - )、ドット ( . )、アンダースコア ( _ ) の任意の文字を使用します。
. *[Save (保存)]*​ をクリックします。
endif::[]

== フローをエクスポートする 

フローを JSON ファイルとしてエクスポートする手順は、次のとおりです。 

ifeval::["{product}"=="salesforce"]
. 既存のフローを開きます。 +
*[<フロー名>]*​ ページが表示されます。
. *[Edit (編集)]*​ をクリックします。 
. レンチアイコン > ​*[Export (エクスポート)]*​ をクリックします。 +
フローが JSON ファイルとしてエクスポートされます。 
endif::[]

ifeval::["{product}"=="mulesoft"]
. 既存のフローを開きます。 +
*[<フロー名>]*​ ページが表示されます。
. *[View (表示)]*​ をクリックします。 
. レンチアイコン > ​*[Export (エクスポート)]*​ をクリックします。 +
フローが JSON ファイルとしてエクスポートされます。 
endif::[]

== フローをインポートする 

フローを JSON ファイルとしてインポートする手順は、次のとおりです。 

ifeval::["{product}"=="salesforce"]
. <<create-a-new-flow,​新しいフローを作成>>​するか、または既存のフローを開きます。 +
*[<フロー名>]*​ ページが表示されます。
. レンチアイコン > ​*[Import - Beta (インポート - ベータ)]*​ をクリックします。 +
*[Select Flow (フローを選択)]*​ ダイアログボックスが表示されます。 
. *[Select flow (フローを選択)]*​ をクリックします。 +
ファイルが表示されます。 
. アップロードする JSON ファイルを探して選択し、​*[Open (開く)]*​ をクリックします。 +
選択したファイルが ​*[Select Flow (フローを選択)]*​ ダイアログボックスに表示されます。 
. *[Connect with <Connector Name> (<コネクタ名> で接続)]*​ ドロップダウンリストから既存の接続を選択するか、または新しい接続を作成します。

* 既存の接続をクリックして選択します。
* *[Add new <Connector Name> Connection (新しい <コネクタ名> 接続を追加)]*​ をクリックし、新しい接続を作成して選択します。 +

. *[Import Flow (フローをインポート)]*​ をクリックします。フローをインポートすると、既存のフローが上書きされます。 +
フローがインポートされて ​*[<フロー名>]*​ ページに保存されます。 
. *[Save (保存)]*​ をクリックします。 +
フローがインポートされます。 
endif::[]

ifeval::["{product}"=="mulesoft"]
. <<create-a-new-flow,​新しいフローを作成>>​するか、または既存のフローを開きます。 +
*[<フロー名>]*​ ページが表示されます。
. *[View (表示)]*​ をクリックします。 +
*[<フロー名>]*​ ページが表示されます。
. レンチアイコン > ​*[Import - Beta (インポート - ベータ)]*​ をクリックします。 +
*[Select Flow (フローを選択)]*​ ダイアログボックスが表示されます。 
. *[Select flow (フローを選択)]*​ をクリックします。 +
ファイルが表示されます。 
. アップロードする JSON ファイルを探して選択し、​*[Open (開く)]*​ をクリックします。 +
選択したファイルが ​*[Select Flow (フローを選択)]*​ ダイアログボックスに表示されます。 
. *[Connect with <Connector Name> (<コネクタ名> で接続)]*​ ドロップダウンリストから既存の接続を選択するか、または新しい接続を作成します。

* 既存の接続をクリックして選択します。
* *[Add new <Connector Name> Connection (新しい <コネクタ名> 接続を追加)]*​ をクリックし、新しい接続を作成して選択します。 +

. *[Import Flow (フローをインポート)]*​ をクリックします。フローをインポートすると、既存のフローが上書きされます。 +
フローがインポートされて ​*[<フロー名>]*​ ページに保存されます。 
. *[Save (保存)]*​ をクリックします。 +
フローがインポートされます。 
endif::[]

== フローを更新する

フローを構築するときにオブジェクトレベルまたは項目レベルで更新されたデータを表示するには、フローの更新が必要になる場合があります。

オブジェクトを更新する手順は、次のとおりです。

. フローを開きます。
. 更新するトリガまたはアクションカードの右上隅にある更新アイコンをクリックします。
+
image:images/composer_refresh_card.png[オブジェクトの更新]
オブジェクト種別のキャッシュがクリアされて、新しいデータが取得されます。

項目を更新する手順は、次のとおりです。

. フローを開きます。
. トリガまたはアクションカードの左下隅にある更新アイコンをクリックします。
+
image:images/composer_refresh_field.png[項目の更新]
項目のキャッシュがクリアされます。項目の新しい値プロバイダが取得されます。

== フロートリガを作成する

フローを作成または複製したら、トリガ (フローを開始するイベントまたは時間間隔) を定義します。フローをテストまたはアクティブ化するには、トリガステップが必要になります。

イベントに基づいてトリガを定義する手順は、次のとおりです。

. フローを開きます (まだ開いていない場合)。​*[What Should Start This Flow? (このフローを開始する要素)]*​ ダイアログが表示されます。
+
image:images/connection-example.png[[What Should Start This Flow (このフローを開始する要素)] ダイアログ, 500]
. トリガイベントが発生するコネクタを選択します。既存の接続が表示されます。
+
image:images/list-of-connections.png[接続のリスト, 500]
+
既存の接続を選択するか、新しい接続を作成できます。

* 既存の接続をクリックして選択します。
* *[Add new ​_connector name_​ Connection (新しい_コネクタ名_接続を追加)]*​ をクリックし、新しい接続を作成して選択します。 +
このダイアログの歯車アイコンをクリックして、接続の名前変更や削除を行うことができます。

. 接続を選択したら、トリガステップが表示されます。
+
image:images/trigger-definition.png[トリガステップ, 600]
+
自動的にトリガに名前が付けられます。どのトリガも、イベントまたは操作とシステム名を組み合わせて名前が付けられます。たとえば、[On new record in Salesforce (Salesforce の新規レコード)] のようになります。

* 必要に応じて、トリガの名前を変更できます。有効な文字: A-Z、a-z、0-9、スペース、ハイフン ( - )、ドット ( . )、アンダースコア ( _ )。

* フローを開始するイベントを選択します。必要に応じて、追加情報を入力します。

* *[Save (保存)]*​ をクリックします。

[[change-a-connection]]
== 接続を変更する

トリガやアクションの接続を変更できます。たとえば、Salesforce Sandbox 組織への接続を使用してフローを作成し、フローのテストが完了した後で本番組織を使用するようにトリガやアクションの接続を変更できます。

同じシステム種別にアクセスする接続のみを変更できます。たとえば、Workday 接続を Google スプレッドシート接続に変更することはできません。

接続を変更する手順は、次のとおりです。

. フローを開きます。
. Sandbox に接続するトリガやアクションの変更アイコンをクリックします。
+
image::images/change-connection.png[接続コントロールの変更, 400]

. 新しい接続を選択して、​*[Save (保存)]*​ をクリックします。

== 接続を修正する

OAuth 接続が失われた場合、アクセストークンを更新して接続を修正できます。

接続を修正する手順は、次のとおりです。

. フローを開きます。
. *[編集]*​ をクリックします。
. 修正が必要なトリガやアクションの変更アイコンをクリックし、​*[Change Connection (接続を変更)]*​ をクリックします。
. *[Repair (修正)]*​ をクリックします。

== 接続の削除

特定の接続が不要になった場合、削除できます。

接続を削除する手順は、次のとおりです。

. <<create-a-new-flow,​新しいフローを作成>>​するか、既存のフローにステップを追加します。
. 新しいフローを作成する場合、次の操作を実行します。
 .. フローを起動するコネクタまたはシステムを選択します。
 .. *[What Should Start This Flow? (このフローを開始する要素)]*​ ウィンドウで、歯車アイコンをクリックします。
. 既存のフローにステップを追加する場合、次の操作を実行します。
 .. フローを起動するコネクタまたはシステムを選択します。
 .. *[Next Step (次のステップ)]*​ ウィンドウで、歯車アイコンをクリックします。
. *[Manage <Connector Name> Connections (<コネクタ名> 接続を管理)]*​ ウィンドウで、削除する接続の横にあるゴミ箱をクリックします。 +
選択した接続を削除することを確認するメッセージが表示されます。ウィンドウが表示され、現在その接続を使用しているフローのリストが表示されます。接続の状況に応じて、実行する操作が異なります。 +
* どのフローでも使用されていない場合、接続を削除できます。
* 非アクティブなフローで使用されている場合、この接続を使用している非アクティブなフローの名前と数が記載されたリストが表示されます。この接続を削除すると、リストに記載されたフローの影響します。非アクティブなフローを再び開いた場合は、​<<change-a-connection,​新しい接続を選択>>​する必要があります。
* アクティブなフローと非アクティブなフローで使用されている場合、この接続を使用しているアクティブなフローと非アクティブなフローの名前、数、状況が記載されたリストが表示されます。接続を削除することを選択すると、再度の確認が表示されます。接続を削除する前に、コンポーザで最初にフローの停止が試みられます。
. *[Delete (削除)]*​ をクリックします。 +
接続が削除されます。

== フローをスケジュールする

接続を選択しない場合、一定間隔で開始するようにフローをスケジュールできます。

フローコントロールを作成する手順は、次のとおりです。

. 新しいフローの ​*[What Should Start This Flow? (このフローを開始する要素)]*​ ダイアログから、[Flow Control (フローコントロール)] セクションを確認して、​*[Scheduler (スケジューラ)]*​ をクリックします。
+
image:images/connection-example.png[[What Should Start This Flow (このフローを開始する要素)] ダイアログ, 500]
. いずれかの時間間隔 (15 分～ 30 日) を選択します。
+
image::images/connection-scheduler.png[期間を使用した新しいトリガ, 500]
. *[Save (保存)]*​ をクリックします。 +
トリガを作成したら、1 つ以上のアクションをフローに追加します。アクションにロジックを適用するには、​<<create-an-if-else-block,​If/Else ブロック>>​または ​<<create-and-test-a-for-each-loop,​For Each>>​ ループを追加します。

== フローのアクセス権のオープン

すべてのユーザは組織内のすべてのフローを表示または管理できます。

この機能は新規顧客ではデフォルトで有効になっており、既存の顧客ではデフォルトで無効になっています。組織レベルでこの機能を無効にするには、コンポーザサポートにお問い合わせください。

=== 制限事項

* フローのオーナーで絞り込むには、最初に ​*[Owner (オーナー)]*​ 項目ではなく ​*[Flow Owner (フローオーナー)]*​ 項目を使用する必要があります。
* *[Flow Owner (フローオーナー)]*​ 項目を使用して絞り込む場合、使用できる演算子は​*「次の文字列で始まる」*​、​*「次の文字列と一致する」*​、​*「次の文字列を含む」*​のみです。​*「次の文字列で始まる」*​、​*「次の文字列と一致する」*​、​*「次の文字列を含む」*​演算子はいずれも、​*「次の文字列を含む」*​演算子の機能を模倣します。
* 既存の顧客の組織では、​*[Flow Owner (フローオーナー)]*​ はデフォルトで ​*[Composer Flows (コンポーザフロー)]*​ タブのリストビューに表示されません。ただし、新規の顧客には、​*[Flow Owner (フローオーナー)]*​ がデフォルトで ​*[Composer Flows (コンポーザフロー)]*​ タブのリストビューに表示されます。

** *[Flow Owner (フローオーナー)]*​ を ​*[Recently viewed (最近参照したデータ)]*​ リストに追加する手順は、次のとおりです。

. *[Composer Flows (コンポーザフロー)]*​ タブから、​*[Recently viewed (最近参照したデータ)]*​ を選択します。
. *[Setup (設定)] > [Search Layouts (検索レイアウト)] > [Composer Flow (コンポーザフロー)] > [Default Layout (デフォルトのレイアウト)]*​ の順に進みます。
. *[Flow Owner (フローオーナー)]*​ を追加します。

** *[Flow Owner (フローオーナー)]*​ を ​*[All (すべて)]*​ (または他の任意のビューリスト) に追加する手順は、次のとおりです。

. *[Composer Flows (コンポーザフロー)]*​ タブから、​*[All (すべて)]*​ を選択します。
. *[List View Controls (リストビューコントロール)] > [Select Fields to Display (表示する項目を選択)]*​ の順に進みます。
. *[Flow Owner (フローオーナー)]*​ を ​*[Available Fields (使用可能な項目)]*​ から ​*[Visible Fields (参照可能項目)]*​ に移動します。
+
* 一括所有権移行や自分以外のユーザへのオーナーの変更はサポートされません。

=== フローを参照する

組織内のすべてのフローを参照し、状況などのフローの詳細を参照してフローがアクティブであるか非アクティブであるかを確認して、最終更新日を参照してフローの変更 (アクティベーションや非アクティベーション以外)、フローオーナー、実行履歴を確認できます。

組織内ですべてのフローを参照する手順は、次のとおりです。

. *[Composer Flows (コンポーザフロー)]*​ タブに移動します。組織内のすべてのフローを参照し、​*フロー名*​、​*状況*​、​*最終更新日*​などのフローの詳細を参照できるようになりました。

=== フローを管理する

組織内のすべてのフローを管理できます。組織内のすべてのフローをアクティブ化または非アクティブ化し、組織内のすべてのフローを削除して、組織内のすべてのフローを編集し、組織内のエラーメール通知フローの所有権を変更できます。

組織内ですべてのフローを管理する手順は、次のとおりです。

. *[Composer Flows (コンポーザフロー)]*​ タブから、フローを選択します。
. 目的のボタンをクリックします。たとえば、​*[Delete (削除)]*​ をクリックしてフローを削除したり、​*[Transfer ownership (所有権の移行)]*​ をクリックしてフローの所有権を変更したりします (エラーメール通知フローの場合のみ)。

== アクションを作成する

アクションを作成する手順は、次のとおりです。

. フローのトリガの後にある大きなプラス記号をクリックして、​*[Add Action (アクションを追加)]*​ ダイアログを開きます。
. アクションの接続をクリックまたは作成します。
+
たとえば、トリガが「new records created in Salesforce」で、アクションを「copy new record to a Google Sheet」にする場合、Google スプレッドシート接続を選択または作成します。
. アクションと表示されるその他の値を選択します。アクションで何を指定する必要があるのかは、アクションで接続するシステム種別によって異なります。
. 編集する項目が​xref:ms_composer_custom_expression_editor.adoc#add-custom-expression-to-an-action[カスタム式]​で有効になっている場合、鉛筆アイコンをクリックします。 +
可能な操作は、テキストを入力すること、または項目の 1 つのデータピルを選択することだけです。(関数、算術演算子、テキストの連結、特殊なトークンが含まれる) 複雑な式を入力する場合、​*カスタム式エディタ*​を使用する必要があります。
. *[Save (保存)]*​ をクリックします。

カスタム式に null 値がある場合、次のようになります。

* 属性のない項目があると、null 値は無視される。必須項目に値がある場合、エラーメッセージが表示されます。省略可能な項目に値がある場合、値は無視され、コネクタに送信されません。 +
* 属性のある項目があると、値は無視され、コネクタに送信されない。

=== 選択リストマッピングの作成

選択リストマッピングを使用すると、あるアプリケーションのデータを別のアプリケーションで必要な対応するデータにマップし、それらのマッピングを組織内のさまざまなフローで再利用できます。これにより、類似した項目で異なる値が含まれる 2 つのアプリケーションを接続し、それらの項目の値をアプリケーション間で調整できます。その後、出力項目 (データピル) の可能な値が入力項目の可能な値にどのようにマップされるかを決定できます。

たとえば、Salesforce レコードの ​*[Country (国)]*​ 項目からデータピルをマップし、NetSuite レコードの ​*[Country (国)]*​ 項目に同じ値を指定できます。

[%header%autowidth.spread]
|===
|Country (国) (Salesforce) | Country (国) (NetSuite)
|US |_unitedStates
|CA |_canada
|DE |_germany
|AR |_argentina
|===

この例では、Salesforce のケースの ​*[Status (状況)]*​ 項目が Zendesk のチケットの ​*[Status (状況)]*​ 項目にマップされ、システム間で項目値の継続性が作成されます。

[%header%autowidth.spread]
|===
|Status (状況) (Salesforce) | Status (状況) (Zendesk)
|New |New
|Working (処理中) |オープン
|Waiting on Customer (顧客待機中) |On-Hold (保留中)
|Escalated (エスカレーション済み) |オープン
|クローズド |クローズド
|===

ソースデータ項目をマップする場合、次の点に留意してください。

* ソース項目は、値の固定リストを含むデータピルである必要がある。
* 対象項目は、列挙​xref:ms_composer_custom_expression_editor.adoc#data-types[データ型]​項目である必要がある。
* ソースシステムからマップされていない他の値が見つかった場合、デフォルトのマッピングで対象システムの値が指定される。デフォルト値を指定しない場合、ソース項目の元の値が対象項目に渡される。
* マッピングは組織レベルで保存され、フロー間で再利用できる。
* マッピングには一意の名前が必要。
* 組織内の全員がマッピング可能。

ソースデータ項目を対象項目にマップする手順は、次のとおりです。

. *[Composer Flows (コンポーザフロー)]*​ タブから、フローを開いて ​*[Edit (編集)]*​ をクリックします。
. アクションカードの ​*[Pick from List (リストから選択)]*​ をサポートする項目で、ドロップダウンメニューから ​*[Picklist Mapping (選択リストマッピング)]*​ を選択します。 +
*[Picklist Mapping (選択リストマッピング)]*​ ウィンドウが表示されます。
. *[Picklist Source (選択リストソース)]*​ セクションの ​*[Source (ソース)]*​ 項目で、​*[Target (対象)]*​ 項目の値にマップする値をドロップダウンリストから選択し、​*[Next (次へ)]*​ をクリックします。
. *[Global Picklist Selection (グローバル選択リストの選択)]*​ セクションで、新しい選択リストを作成するか、既存の選択リストを選択します。

=== 新しい選択リストを作成する

新しい選択リストを作成する手順は、次のとおりです。

. *[Create new picklist (新規選択リストを作成)]*​ をクリックします。
. *[Global picklist name (グローバル選択リスト名)]*​ 項目に、選択リストの一意の名前を入力します。
. 必要に応じて、​*[Description (説明)]*​ 項目に選択リストの説明を入力します。次の説明は、ソースシステムと対象システムに基づいて自動的に入力されます。 +
`This maps [Source Field Name] from [Source Connection Name] to [Target Field Name] from [Target Connection Name] (これは、[ソース接続名] からの [ソース項目名] を [対象接続名] からの [対象項目名] にマップします)`
. テーブルで、ソース項目とその対象マッピングを選択します。
. 必要に応じて、項目マッピングをさらに追加するには、​*[Add Row (行を追加)]*​ をクリックしてソース項目の値を手動で入力し (各値を表す行を使用)、ドロップダウンから対象マッピングを選択します。
. 該当するすべての項目マッピングを追加したら、​*[Create Picklist (選択リストを作成)]*​ をクリックします。
. *[Apply (適用)]*​ をクリックします。 +
*[<選択リスト名>]*​ セクションが表示され、値とそのマッピングのテーブルが表示されます。

=== 既存の選択リストを選択する

既存の選択リストを選択する手順は、次のとおりです。

. リストから選択リストを選択します。既存の選択リストに加えられたすべての編集は、その選択リストが現在使用されているすべてのフローに影響します。
. 必要に応じて、​*[<選択リスト名>]*​ セクションで値を編集するには、鉛筆をクリックします。値を編集したら、​*[Save Picklist (選択リストを保存)]*​ をクリックして、​*[Apply (適用)]*​ をクリックします。
. 必要に応じて、​*[<選択リスト名>]*​ セクションで選択リストを削除するには、ごみ箱をクリックします。グローバル選択リストを削除すると、その選択リストを現在使用しているすべてのフローに影響します。
. *[Apply (適用)]*​ をクリックします。 +
アクションカードが表示されます。

== フローコントロールを作成する

アクションの前にロジックを実行する必要がある場合、まずフローコントロールを選択します。

. フローのトリガの後にある大きなプラス記号をクリックして、​*[Add Action (アクションを追加)]*​ ダイアログを開きます。
. *[If/Else Block (If/Else ブロック)]*​ または ​*[For Each]*​ のいずれかをクリックします。1 つ以上の条件に基づいて異なるアクションを実行する必要がある場合、If/Else ブロックが適しています。レコードセットを処理する場合、For Each ループが適しています。
. フローコントロールを完成させます。通常、この作業にはアクションの追加が含まれます。
. *[Save (保存)]*​ をクリックします。

[[create-an-if-else-block]]
=== If/Else ブロックを追加する

If/Else ブロックを作成して条件を設定し、特定の条件を満たした場合にのみアクションを実行できます。これにより、複数の線形分岐をカバーするフローを作成できるようになり、個別のフローを作成する必要がなくなります。

分岐は、フローで垂直方向に実行されるロジックベースのステップです。各分岐内に複数のステップを追加できます。その後、各分岐が順次実行されます。

決定ステップを追加すると、フローの前のステップを指定するときに選択された値に基づいて ​*[Field (項目)]*​ リストの値が入力されます。​*[Field (項目)]*​ の値が選択されると、すべての互換性のある値のオプションが​<<supported-operators,​*演算子*>>​リストに表示されます。選択された ​*[Operator (演算子)]*​ で条件を完成させるために 2 番目のデータピルが必要な場合、​*[Value (値)]*​ 項目が有効になり、トリガを定義するときに選択した値に基づいてリストが入力されます。​*[Value (値)]*​ 項目では、値を手動で入力するか、フローの既存のデータを使用して設定できます。

フローを構築するときにいずれかの日付項目に値がない状態で日付の比較を開始すると、フローを比較できるように欠落値はデフォルトで ​`0001-01-01`​ に更新されます。

If/Else ブロックで条件を構築する場合、次の演算子がサポートされます。

[[supported-operators]]
[%header%autowidth.spread]
|===
|関数 | サポートされるデータ型 | 値は必須? | 注意事項
|Equals (次の文字列と一致する)/Does not equal (次の文字列と一致しない) | すべて | はい |この項目の値の文字列は大文字と小文字が区別されます。
|Contains (次の文字列を含む)/Does not contain (次の文字列を含まない) | Array、String | はい | なし
|Greater than (次の値より大きい)/Less than (次の値未満) | Date、Number | はい | *[Date (日付)]*​ 項目の ​*[Greater than (次の値より大きい)]*​ の値は後の日付と等しくなり、​*[Less than (次の値未満)]*​ の値は前の日付と等しくなります。
|Greater than or equal (以上)/Less than or equal (以下) | Date、Number | はい | *[Date (日付)]*​ 項目の ​*[Greater than or equal (以上)]*​ の値は現在の日付または後の日付と等しくなり、​*[Less than or equal (以下)]*​ の値は前の日付または現在の日付と等しくなります。
|Is empty (空)/Is not empty (空でない) |Array、String、Object | いいえ | なし
|Starts with (次の文字列で始まる)/Ends with (次の文字列で終わる) | String (文字列) | はい | この項目の文字列値は必須です。
|Is true (true)/Is false (false) | Boolean (ブール) | いいえ | なし
| Is present (存在する)/Is not present (存在しない) | すべて | いいえ | この項目の値が null の場合や、値が選択されていない場合、この項目の値はデフォルトで ​*[Not present (存在しない)]*​ に設定されます。
|===

If/Else ブロックを作成する手順は、次のとおりです。

. フローのトリガまたは最後のアクションの後のプラス記号をクリックします。
. *[Add Action (アクションを追加)]*​ をクリックします。
. *[If/Else Block (If/Else ブロック)]*​ をクリックして最初の分岐を定義します。
. 要求条件を入力します。​`すべての条件が満たされる必要がある (AND)`​、​`いずれかの条件が満たされる必要がある (OR)`​ ことを指定するか、条件の順序とグループ化を​<<use-custom-logic,​カスタマイズ>>​できます。
. *[+]*​ をクリックして、その分岐にアクションを追加します。各分岐には、アクション (​_ステップ_​とも呼ばれる) が必要です。
. 別の分岐を追加する場合、​*[Add If (If を追加)]*​ をクリックして、作成する If/Else 分岐ごとに前のステップを繰り返します。
. 既存の分岐のどの条件も満たされないときにフローをどのように実行するのかに関する条件を設定する場合、​*[Add Else (Else を追加)]*​ をクリックして、最後の分岐について前の手順を繰り返します。
. If/Else ブロックに他の条件を追加する場合、​*[Add condition (条件を追加)]*​ をクリックします。
. すべての分岐を追加したら、​*[Save (保存)]*​ をクリックします。

[[use-custom-logic]]
== カスタムロジックを使用する

カスタムロジックは、If/Else ステートメントの If ステートメントブロック内の各条件の行番号と、​`OR`​、​`AND`​、​`NOT`​ を使用して、複雑な式を作成します。カスタムロジックオプションを選択すると、各条件に番号が割り当てられ、その番号を使用して条件の操作の順序をカスタマイズできます。

カスタムロジックを使用する場合、式を検証するには、定義されているすべての条件が式で参照されている必要があります。たとえば、3 つの条件が定義されている場合、「1 and (2 or 1)」と入力すると、「3」は参照されないため、式は無効になります。

 カスタムロジックを使用すると、最大 20 個の条件を設定でき、条件を複数回参照できます。

[[create-and-test-a-for-each-loop]]
== For Each ループを作成する

For Each ループを作成する手順は次のとおりです。

. フローのトリガまたは最後のアクションの後のプラス記号をクリックします。
. *[Add Action (アクションを追加)]*​ をクリックします。
. *[For Each]*​ をクリックします。
. *[Input list (入力リスト)]*​ からデータピルを選択します。レコードセットを返すトリガまたはアクションが必要です。それらがない場合、ここでは何も選択できません。
. プラス記号をクリックして、アクションを追加します。
. アクションが完了したら、​*[Save (保存)]*​ をクリックします。

フローで何を実行する必要があるのかに応じて、異なるパターンでロジックおよびアクションを追加できます。

== エラーハンドラの設定 

フローの実行時にフローの特定のステップで接続エラーやロジックエラーを監視して、エラーを処理するためのロジックを指定できます。また、エラーが発生した場合に追加のアクションを実行したり通知を送信したりするためのステップも設定できます。  

[[access-error-handling]]
=== エラーハンドラにアクセスする 

エラーハンドラにアクセスする手順は、次のとおりです。

. <<create-a-new-flow,​新しいフローを作成>>​するか、または既存のフローを開きます。
.. 新しいフローを作成する場合、次の操作を実行します。
... フローを起動するコネクタまたはシステムを選択します。
... トリガを選択して設定します。 
... アクションを選択して設定します。
... 監視するステップの直前にエラーハンドラを追加して、プラスボタンをクリックします。 
... *[What Should Start This Flow? (このフローを開始する要素)]*​ ウィンドウで ​*[Error Handler (Beta) (エラーハンドラ (ベータ))]*​ をクリックします。
.. 既存のフローにステップを追加する場合、次の操作を実行します。
... フローを開きます。
... 監視するステップの直前にエラーハンドラを追加して、プラスボタンをクリックします。 
... *[Next Step (次のステップ)]*​ ウィンドウで、​*[Error Handler (Beta) (エラーハンドラ (ベータ))]*​ をクリックします。 

[[watch-a-step]]
=== ステップを監視する 

特定のステップで接続エラーやロジックエラーを監視することができます。エラーが発生すると、フローが通常の処理を停止して、エラーハンドラのステップの処理を開始します。このセクションでは、1 つ以上のステップを追加できます。

ステップを監視する手順は、つぎのとおりです。 

. <<access-error-handling,​フローのエラーハンドラにアクセスします>>​。
. *[Error Handler (エラーハンドラ)]*​ カードの ​*[Watch (監視)]*​ セクションで、プラス記号をクリックして、監視するアクションを選択します。または、監視するステップを ​*[Watch (監視)]*​ セクションにドラッグします。 +
選択したアクションが ​*[Watch (監視)]*​ セクションに表示されます。エラーが発生すると、フローが ​*[On Error (エラー発生時)]*​ セクションで選択されているアクションに移行します。
. 監視するアクションを追加するには、前の手順を繰り返します。

=== コンポーザでのエラー処理の設定 

*[Watch (監視)]*​ セクションで遭遇したエラーを処理するようにコンポーザを設定できます。監視対象のアクションでエラーが発生すると、設定に応じて ​*[On Error (エラー発生時)]*​ セクションの処理にフローが移行します。​*[On Error (エラー発生時)]*​ セクションには、実行するステップを 1 つ以上追加できます。 

==== エラー処理の動作

* デフォルトでは、​*[On Error (エラー発生時)]*​ セクションでは 1 つの条件のみを指定できますが、複数の条件を追加することもできます。 
* 新しい条件を追加すると、​*[On Error (エラー発生時)]*​ 条件項目の値はデフォルトで ​`[None (なし)]`​ に設定されます。この値を ​`[None (なし)]`​ のままにすると、​*[Watch (監視)]*​ セクションで発生したすべてのエラーが返され、この ​*[On Error (エラー発生時)]*​ セクションのすべてのステップが実行されます。 
* *[On Error (エラー発生時)]*​ セクションの条件と一致すると、エラーハンドラは条件を順に処理して、最初に一致した条件のステップを実行します。最初の条件と一致した後は、残りのステップはスキップされます。​*[On Error (エラー発生時)]*​ セクションの分岐を既存の ​*[On Error (エラー発生時)]*​ セクション内に追加することで、処理を続行させることができます。
* xref:ms_composer_test_flow.adoc[フローをテスト]​すると、エラーハンドラが捕捉したエラーがアクションカードの右側のペインに表示されます。正常に実行されたステップには緑のチェックマーク、失敗したステップには赤の X でマークされます。 
* 監視対象のアクションでエラーが発生すると、エラー情報がデータピルとして保存されます。データピルは、以降の通知アクションやレコード更新アクションで使用できます。たとえば、エラーが発生した場合に、データピルのエラー情報を含めたメールをチームに送信するためのアクションを実行するように指定できます。

==== [On Error (エラー発生時)] セクションにステップを追加する 

*[On Error (エラー発生時)]*​ セクションにステップを追加する手順は、次のとおりです。 

. <<watch-a-step,​監視するステップを選択します>>​。
. *[Error Handler (エラーハンドラ)]*​ カードの ​*[On Error (エラー発生時)]*​ セクションで、次の操作を行います。 
.. *[Conditions to run this branch (この分岐を実行する条件)]*​ ドロップダウンで、次のいずれかの条件を選択し、必要な条件を入力します。 
*** `AND`​: すべての条件と一致します。
*** `OR`​: いずれかの条件と一致します。
*** `None (なし)`​: どの条件とも一致しない場合でもすべてのエラーを返します。
*** `Custom Logic (カスタムロジック)`​: <<use-custom-logic,​条件と一致するためのカスタムロジック>>​を指定します。 
.. *[After Running (実行後)]*​ ドロップダウンリストで、次のいずれかを選択します。 
*** *Stop (停止)*​: *[On Error (エラー発生時)]*​ セクションのすべてのステップを処理した後で、コンポーザはエラーフラグを立ててフローを停止します。​<<flow-details-page,​*[Run History (実行履歴)]*>>​ ページのフローの ​_[Status (状況)]_​ 項目には ​`[FAILED (失敗)]`​ と表示されます。 
*** *Continue (続行)*​: *[On Error (エラー発生時)]*​ セクションのすべてのステップを処理した後で、コンポーザはエラーを解消してフローを続行します。エラーが発生しなかった場合は、​<<flow-details-page,​*[Run History (実行履歴)]*>>​ ページのフローの ​_[Status (状況)]_​ 項目には ​`[SUCCESS (成功)]`​ と表示されます。
. *[On Error (エラー発生時)]*​ セクションに他の条件を追加する場合は、​*[Add Condition (条件を追加)]*​ をクリックします。 
. 特定のエラー条件を監視して、その処理方法を既存の ​*[On Error (エラー発生時)]*​ セクションで指定するには、​*[Add On Error (追加エラー発生時)]*​ をクリックして、新しい分岐とステップを追加します。 +
*[On Error (エラー発生時)]*​ セクションに分岐を追加する場合は、​*[After Running (実行後)]*​ セクションで次のいずれかを選択します。 
** *[Continue (続行)]*​: *[On Error (エラー発生時)]*​ セクションのステップを実行してから、親ステップ内の次のステップを続行します。 
** *[Propagate (伝播)]*​: *[On Error (エラー発生時)]*​ セクションのステップを実行してから、親エラーハンドラセクションにエラーをプッシュします。子ステップは処理を終了し、エラーハンドラプロセスは親ステップに戻ります。 
. 必要に応じて、​*[On Error (エラー発生時)]*​ セクションでプラスボタンをクリックして、エラーを処理するためのステップを追加できます。 
.. *[Next Step (次のステップ)]*​ ウィンドウで、​*[System Action (システムアクション)]*​ を選択します。 
.. エラーが発生したときに実行するアクションを選択します。たとえば、​*レコード ID*​ とエラー情報を含む通知メールをチームに送信して、エラー情報でソースレコードを更新するアクションを追加します。 
.. アクションを設定します。 
. フローを保存します。 
. xref:ms_composer_test_flow.adoc[フローをテスト]​します。
. xref:ms_composer_activation.adoc[フローをアクティブ化]​します。

include::_partials/see-also.adoc[]
