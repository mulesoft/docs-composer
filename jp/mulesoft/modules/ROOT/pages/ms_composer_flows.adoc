
= コンポーザフローの構築

xref:ms_composer_checklist.adoc[準備チェックリスト]​に記載された情報を収集したら、フローを構築、​xref:ms_composer_activation.adoc[アクティブ化]​、​xref:ms_composer_monitoring.adoc[監視]​できます。フローの構築には、新しいフローを作成したり、既存のフローを複製したり、トリガを追加してテストしたり、フローによって実行される各アクションを実行順序で追加してテストしたり、アクティブ化する前に最終的に新しいフローをテストして完了したりする作業が含まれます。

各トリガおよびアクションをフローに追加するときに​xref:ms_composer_test_flow.adoc[テスト]​します。


== フローを作成する

新しいフローを作成したり、既存のフローを複製したりできます。

[[create-a-new-flow]]
=== 新しいフローを作成する

新しいフローを作成する手順は、次のとおりです。

ifeval::["​{product}​"=="salesforce"]
. コンポーザの ​*[Home (ホーム)]*​ ページで、​*[Create New Flow (新規フローを作成)]*​ をクリックします。 +
自動的にフローに名前が付けられます。
. 必要に応じて、​*[_フロー名_]*​ の横にある鉛筆アイコンをクリックしてフローの名前を変更します。有効な文字: A-Z、a-z、0-9、スペース、ハイフン ( - )、ドット ( . )、アンダースコア ( _ )。
. *[Save (保存)]*​ をクリックします。
endif::[]

ifeval::["​{product}​"=="mulesoft"]
. コンポーザの ​*[Home (ホーム)]*​ ページで、​*[Create new flow (新規フローを作成)]*​ をクリックします。 +
自動的にフローに名前が付けられます。
. 自動的に作成された新しいフローの名前を変更するには、​*[Untitled Flow (タイトル未定のフロー)]*​ の横にある鉛筆アイコンをクリックし、A-Z、a-z、0-9、スペース、ハイフン ( - )、ドット ( . )、アンダースコア ( _ ) の任意の文字を使用してカスタム名を作成します。
. *[Save (保存)]*​ をクリックします。
endif::[]

これでフロートリガを作成する準備ができました。

=== 既存のフローを複製する

既存のフローを複製する手順は、次のとおりです。

ifeval::["​{product}​"=="salesforce"]
. *[Composer Flows (コンポーザフロー)]*​ から、複製するフローの名前をクリックします。コンポーザに ​*[Flow Details (フローの詳細)]*​ ページが表示されます。
. *[Clone (複製)]*​ をクリックします。
. コンポーザは、既存のフローをコピーして、[Flow Details (フローの詳細)] ページで開きます。フローの名前は ​*[Copy of _original flow name_ (_元のフロー名_のコピー)]*​ となります。
. 必要に応じて、​*[Copy of _original flow name_ (_元のフロー名_のコピー)]*​ の横にある鉛筆アイコンをクリックしてフローの名前を変更します。有効な文字: A-Z、a-z、0-9、スペース、ハイフン ( - )、ドット ( . )、アンダースコア ( _ )。
. *[Save (保存)]*​ をクリックします。
endif::[]

ifeval::["​{product}​"=="mulesoft"]
. サイドバーから、​*[Flows (フロー)]*​ をクリックします。
. *[Flows (フロー)]*​ ページで、複製するフローの名前をクリックします。
. *[Clone (複製)]*​ をクリックします。
+
コンポーザは、既存のフローをコピーして、[Flow Details (フローの詳細)] ページで開きます。フローの名前は ​*[Copy of _original flow name_ (_元のフロー名_のコピー)]*​ となります。
. フローの名前を変更するには、​*[Copy of _original flow name_ (_元のフロー名_のコピー)]*​ の横にある鉛筆アイコンをクリックし、A-Z、a-z、0-9、スペース、ハイフン ( - )、ドット ( . )、アンダースコア ( _ ) の任意の文字を使用します。
. *[Save (保存)]*​ をクリックします。
endif::[]

== フローを更新する

フローを構築するときにオブジェクトレベルまたは項目レベルで更新されたデータを表示するには、フローの更新が必要になる場合があります。

オブジェクトを更新する手順は、次のとおりです。

. フローを開きます。
. 更新するトリガまたはアクションカードの右上隅にある更新アイコンをクリックします。
+
image:images/composer_refresh_card.png[オブジェクトの更新]
オブジェクト種別のキャッシュがクリアされて、新しいデータが取得されます。

項目を更新する手順は、次のとおりです。

. フローを開きます。
. トリガまたはアクションカードの左下隅にある更新アイコンをクリックします。
+
image:images/composer_refresh_field.png[項目の更新]
項目のキャッシュがクリアされます。項目の新しい値プロバイダが取得されます。

== フロートリガを作成する

フローを作成または複製したら、トリガ (フローを開始するイベントまたは時間間隔) を定義します。フローをテストまたはアクティブ化するには、トリガステップが必要になります。

イベントに基づいてトリガを定義する手順は、次のとおりです。

. フローを開きます (まだ開いていない場合)。​*[What Should Start This Flow? (このフローを開始する要素)]*​ ダイアログが表示されます。
+
image:images/connection-example.png[[What Should Start This Flow (このフローを開始する要素)] ダイアログ, 500]
. トリガイベントが発生するコネクタを選択します。既存の接続が表示されます。
+
image:images/list-of-connections.png[接続のリスト, 500]
+
既存の接続を選択するか、新しい接続を作成できます。

* 既存の接続をクリックして選択します。
* *[Add new _connector name_ Connection (新しい_コネクタ名_接続を追加)]*​ をクリックし、新しい接続を作成して選択します。 +
このダイアログの歯車アイコンをクリックして、接続の名前変更や削除を行うことができます。

. 接続を選択したら、トリガステップが表示されます。
+
image:images/trigger-definition.png[トリガステップ, 600]
+
自動的にトリガに名前が付けられます。どのトリガも、イベントまたは操作とシステム名を組み合わせて名前が付けられます。たとえば、[On new record in Salesforce (Salesforce の新規レコード)] のようになります。

* 必要に応じて、トリガの名前を変更できます。有効な文字: A-Z、a-z、0-9、スペース、ハイフン ( - )、ドット ( . )、アンダースコア ( _ )。

* フローを開始するイベントを選択します。必要に応じて、追加情報を入力します。

* *[Save (保存)]*​ をクリックします。

[[change-a-connection]]
== 接続を変更する

トリガやアクションの接続を変更できます。たとえば、Salesforce Sandbox 組織への接続を使用してフローを作成し、フローのテストが完了した後で本番組織を使用するようにトリガやアクションの接続を変更できます。

同じシステム種別にアクセスする接続のみを変更できます。たとえば、Workday 接続を Google スプレッドシート接続に変更することはできません。

接続を変更する手順は、次のとおりです。

. フローを開きます。
. Sandbox に接続するトリガやアクションの変更アイコンをクリックします。
+
image::images/change-connection.png[接続コントロールの変更, 400]

. 新しい接続を選択して、​*[Save (保存)]*​ をクリックします。

== 接続を修正する

OAuth 接続が失われた場合、アクセストークンを更新して接続を修正できます。

接続を修正する手順は、次のとおりです。

. フローを開きます。
. *[編集]*​ をクリックします。
. 修正が必要なトリガやアクションの変更アイコンをクリックし、​*[Change Connection (接続を変更)]*​ をクリックします。
. *[Repair (修正)]*​ をクリックします。

== 接続の削除

特定の接続が不要になった場合、削除できます。

接続を削除する手順は、次のとおりです。

. <<create-a-new-flow​,新しいフローを作成>>​するか、既存のフローにステップを追加します。
. 新しいフローを作成する場合、次の操作を実行します。
 .. フローを起動するコネクタまたはシステムを選択します。
 .. *[What Should Start This Flow? (このフローを開始する要素)]*​ ウィンドウで、歯車アイコンをクリックします。
. 既存のフローにステップを追加する場合、次の操作を実行します。
 .. フローを起動するコネクタまたはシステムを選択します。
 .. *[Next Step (次のステップ)]*​ ウィンドウで、歯車アイコンをクリックします。
. *[Manage <Connector Name> Connections (<コネクタ名> 接続を管理)]*​ ウィンドウで、削除する接続の横にあるゴミ箱をクリックします。 +
選択した接続を削除することを確認するメッセージが表示されます。ウィンドウが表示され、現在その接続を使用しているフローのリストが表示されます。接続の状況に応じて、実行する操作が異なります。 +
* どのフローでも使用されていない場合、接続を削除できます。
* 無効なフローで使用されている場合、この接続を使用している無効なフローの名前と数が記載されたリストが表示されます。この接続を削除すると、リストに記載されたフローの影響します。無効なフローを再び開いた場合は、​<<change-a-connection​,新しい接続を選択>>​する必要があります。
* アクティブなフローと非アクティブなフローで使用されている場合、この接続を使用しているアクティブなフローと非アクティブなフローの名前、数、状況が記載されたリストが表示されます。接続を削除することを選択すると、再度の確認が表示されます。接続を削除する前に、コンポーザで最初にフローの停止が試みられます。
. *[Delete (削除)]*​ をクリックします。 +
接続が削除されます。

== フローをスケジュールする

接続を選択しない場合、一定間隔で開始するようにフローをスケジュールできます。

フローコントロールを作成する手順は、次のとおりです。

. 新しいフローの ​*[What Should Start This Flow? (このフローを開始する要素)]*​ ダイアログから、[Flow Control (フローコントロール)] セクションを確認して、​*[Scheduler (スケジューラ)]*​ をクリックします。
+
image:images/connection-example.png[[What Should Start This Flow (このフローを開始する要素)] ダイアログ, 500]
. いずれかの時間間隔 (15 分～ 30 日) を選択します。
+
image::images/connection-scheduler.png[期間を使用した新しいトリガ, 500]
. *[Save (保存)]*​ をクリックします。 +
トリガを作成したら、1 つ以上のアクションをフローに追加します。アクションにロジックを適用するには、​<<create-an-if-else-block​,If/Else ブロック>>​または ​<<create-and-test-a-for-each-loop​,For Each>>​ ループを追加します。

ifeval::["​{product}​"=="salesforce"]
== フローのアクセス権のオープン

すべてのユーザは組織内のすべてのフローを表示または管理できます。

この機能は新規顧客ではデフォルトで有効になっており、既存の顧客ではデフォルトで無効になっています。組織レベルでこの機能を無効にするには、コンポーザサポートにお問い合わせください。

=== 制限事項

* フローのオーナーで絞り込むには、最初に ​*[Owner (オーナー)]*​ 項目ではなく ​*[Flow Owner (フローオーナー)]*​ 項目を使用する必要があります。
* *[Flow Owner (フローオーナー)]*​ 項目を使用して絞り込む場合、使用できる演算子は​*「次の文字列で始まる」*​、​*「次の文字列と一致する」*​、​*「次の文字列を含む」*​のみです。​*「次の文字列で始まる」*​、​*「次の文字列と一致する」*​、​*「次の文字列を含む」*​演算子はいずれも、​*「次の文字列を含む」*​演算子の機能を模倣します。
* 既存の顧客の組織では、​*[Flow Owner (フローオーナー)]*​ はデフォルトで ​*[Composer Flows (コンポーザフロー)]*​ タブのリストビューに表示されません。ただし、新規の顧客には、​*[Flow Owner (フローオーナー)]*​ がデフォルトで ​*[Composer Flows (コンポーザフロー)]*​ タブのリストビューに表示されます。

** *[Flow Owner (フローオーナー)]*​ を ​*[Recently viewed (最近参照したデータ)]*​ リストに追加する手順は、次のとおりです。

. *[Composer Flows (コンポーザフロー)]*​ タブから、​*[Recently viewed (最近参照したデータ)]*​ を選択します。
. *[Setup (設定)] > [Search Layouts (検索レイアウト)] > [Composer Flow (コンポーザフロー)] > [Default Layout (デフォルトのレイアウト)]*​ の順に進みます。
. *[Flow Owner (フローオーナー)]*​ を追加します。

** *[Flow Owner (フローオーナー)]*​ を ​*[All (すべて)]*​ (または他の任意のビューリスト) に追加する手順は、次のとおりです。

. *[Composer Flows (コンポーザフロー)]*​ タブから、​*[All (すべて)]*​ を選択します。
. *[List View Controls (リストビューコントロール)] > [Select Fields to Display (表示する項目を選択)]*​ の順に進みます。
. *[Flow Owner (フローオーナー)]*​ を ​*[Available Fields (使用可能な項目)]*​ から ​*[Visible Fields (参照可能項目)]*​ に移動します。
+
* 一括所有権移行や自分以外のユーザへのオーナーの変更はサポートされません。

=== フローを参照する

組織内のすべてのフローを参照し、状況などのフローの詳細を参照してフローがアクティブであるか非アクティブであるかを確認して、最終更新日を参照してフローの変更 (アクティベーションや非アクティベーション以外)、フローオーナー、実行履歴を確認できます。

組織内ですべてのフローを参照する手順は、次のとおりです。

. *[Composer Flows (コンポーザフロー)]*​ タブに移動します。組織内のすべてのフローを参照し、​*フロー名*​、​*状況*​、​*最終更新日*​などのフローの詳細を参照できるようになりました。

=== フローを管理する

組織内のすべてのフローを管理できます。組織内のすべてのフローをアクティブ化または非アクティブ化し、組織内のすべてのフローを削除して、組織内のすべてのフローを編集し、組織内のエラーメール通知フローの所有権を変更できます。

組織内ですべてのフローを管理する手順は、次のとおりです。

. *[Composer Flows (コンポーザフロー)]*​ タブから、フローを選択します。
. 目的のボタンをクリックします。たとえば、​*[Delete (削除)]*​ をクリックしてフローを削除したり、​*[Transfer ownership (所有権の移行)]*​ をクリックしてフローの所有権を変更したりします (エラーメール通知フローの場合のみ)。
endif::[]

== アクションを作成する

アクションを作成する手順は、次のとおりです。

. フローのトリガの後にある大きなプラス記号をクリックして、​*[Add Action (アクションを追加)]*​ ダイアログを開きます。
. アクションの接続をクリックまたは作成します。
+
たとえば、トリガが「new records created in Salesforce」で、アクションを「copy new record to a Google Sheet」にする場合、Google スプレッドシート接続を選択または作成します。
. アクションと表示されるその他の値を選択します。アクションで何を指定する必要があるのかは、アクションで接続するシステム種別によって異なります。
. 編集する項目が​xref:ms_composer_custom_expression_editor.adoc#add-custom-expression-to-an-action[カスタム式]​で有効になっている場合、鉛筆アイコンをクリックします。 +
可能な操作は、テキストを入力すること、または項目の 1 つのデータピルを選択することだけです。(関数、算術演算子、テキストの連結、特殊なトークンが含まれる) 複雑な式を入力する場合、​*カスタム式エディタ*​を使用する必要があります。
. *[Save (保存)]*​ をクリックします。

カスタム式に null 値がある場合、次のようになります。

* 属性のない項目があると、null 値は無視される。必須項目に値がある場合、エラーメッセージが表示されます。省略可能な項目に値がある場合、値は無視され、コネクタに送信されません。 +
* 属性のある項目があると、値は無視され、コネクタに送信されない。

== フローコントロールを作成する

アクションの前にロジックを実行する必要がある場合、まずフローコントロールを選択します。

. フローのトリガの後にある大きなプラス記号をクリックして、​*[Add Action (アクションを追加)]*​ ダイアログを開きます。
. *[If/Else Block (If/Else ブロック)]*​ または ​*[For Each]*​ のいずれかをクリックします。1 つ以上の条件に基づいて異なるアクションを実行する必要がある場合、If/Else ブロックが適しています。レコードセットを処理する場合、For Each ループが適しています。
. フローコントロールを完成させます。通常、この作業にはアクションの追加が含まれます。
. *[Save (保存)]*​ をクリックします。

[[create-an-if-else-block]]
=== If/Else ブロックを追加する

If/Else ブロックを作成して条件を設定し、特定の条件を満たした場合にのみアクションを実行できます。これにより、複数の線形分岐をカバーするフローを作成できるようになり、個別のフローを作成する必要がなくなります。

分岐は、フローで垂直方向に実行されるロジックベースのステップです。各分岐内に複数のステップを追加できます。その後、各分岐が順次実行されます。

決定ステップを追加すると、フローの前のステップを指定するときに選択された値に基づいて ​*[Field (項目)]*​ リストの値が入力されます。​*[Field (項目)]*​ の値が選択されると、すべての互換性のある値のオプションが​<<supported-operators​,*演算子*>>​リストに表示されます。選択された ​*[Operator (演算子)]*​ で条件を完成させるために 2 番目のデータピルが必要な場合、​*[Value (値)]*​ 項目が有効になり、トリガを定義するときに選択した値に基づいてリストが入力されます。​*[Value (値)]*​ 項目では、値を手動で入力するか、フローの既存のデータを使用して設定できます。

フローを構築するときにいずれかの日付項目に値がない状態で日付の比較を開始すると、フローを比較できるように欠落値はデフォルトで ​`0001-01-01`​ に更新されます。

If/Else ブロックで条件を構築する場合、次の演算子がサポートされます。

[[supported-operators]]
[%header%autowidth.spread]
|===
|関数 | サポートされるデータ型 | 値は必須? | 注意事項
|Equals (次の文字列と一致する)/Does not equal (次の文字列と一致しない) | すべて | はい |この項目の値の文字列は大文字と小文字が区別されます。
|Contains (次の文字列を含む)/Does not contain (次の文字列を含まない) | Array、String | はい | なし
|Greater than (次の値より大きい)/Less than (次の値未満) |  Date、Number | はい | ​*[Date (日付)]*​ 項目の ​*[Greater than (次の値より大きい)]*​ の値は後の日付と等しくなり、​*[Less than (次の値未満)]*​ の値は前の日付と等しくなります。
|Greater than or equal (以上)/Less than or equal (以下) | Date、Number | はい | ​*[Date (日付)]*​ 項目の ​*[Greater than or equal (以上)]*​ の値は現在の日付または後の日付と等しくなり、​*[Less than or equal (以下)]*​ の値は前の日付または現在の日付と等しくなります。
|Is empty (空)/Is not empty (空でない) |Array、String、Object | いいえ | なし
|Starts with (次の文字列で始まる)/Ends with (次の文字列で終わる) | String (文字列) | はい | この項目の文字列値は必須です。
|Is true (true)/Is false (false) | Boolean (ブール) | いいえ | なし
| Is present (存在する)/Is not present (存在しない) | すべて | いいえ | この項目の値が null の場合や、値が選択されていない場合、この項目の値はデフォルトで ​*[Not present (存在しない)]*​ に設定されます。
|===

If/Else ブロックを作成する手順は、次のとおりです。

. フローのトリガまたは最後のアクションの後のプラス記号をクリックします。
. *[Add Action (アクションを追加)]*​ をクリックします。
. *[If/Else Block (If/Else ブロック)]*​ をクリックして最初の分岐を定義します。
. 要求条件を入力します。
. *[+]*​ をクリックして、その分岐にアクションを追加します。各分岐には、アクション (​_ステップ_​とも呼ばれる) が必要です。
. 別の分岐を追加する場合、​*[Add If (If を追加)]*​ をクリックして、作成する If/Else 分岐ごとに前のステップを繰り返します。
. 既存の分岐のどの条件も満たされないときにフローをどのように実行するのかに関する条件を設定する場合、​*[Add Else (Else を追加)]*​ をクリックして、最後の分岐について前の手順を繰り返します。
. If/Else ブロックに他の条件を追加する場合、​*[Add condition (条件を追加)]*​ をクリックします。
. すべての分岐を追加したら、​*[Save (保存)]*​ をクリックします。

[[create-and-test-a-for-each-loop]]
=== For Each ループを作成する

For Each ループを作成する手順は次のとおりです。

. フローのトリガまたは最後のアクションの後のプラス記号をクリックします。
. *[Add Action (アクションを追加)]*​ をクリックします。
. *[For Each]*​ をクリックします。
. *[Input list (入力リスト)]*​ からデータピルを選択します。レコードセットを返すトリガまたはアクションが必要です。それらがない場合、ここでは何も選択できません。
. プラス記号をクリックして、アクションを追加します。
. アクションが完了したら、​*[Save (保存)]*​ をクリックします。

フローで何を実行する必要があるのかに応じて、異なるパターンでロジックおよびアクションを追加できます。

include::_partials/see-also.adoc[]
